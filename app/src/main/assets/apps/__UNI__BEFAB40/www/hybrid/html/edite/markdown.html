<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="editormd.preview.css" />
		<link rel="stylesheet" href="editormd.css" />
		<link rel="stylesheet" href="katex.min.css" />

		<!-- <link rel="shortcut icon" href="https://pandao.github.io/editor.md/favicon.ico" type="image/x-icon" /> -->
		<style>
			#test-editormd {
				width: 100%;
				min-height: 100vh !important;
				margin: 0 auto;
				overflow: hidden;
			}

			html,
			body {
				margin: 0;
				padding: 0;
			}

			#test-editormd-vale {
				height: 100%;
				width: 100%;
			}
		</style>
	</head>
	<body style="backgroundColor:transparent">
		<div id="test-editormd">
			<textarea style="display:none;"></textarea>
		</div>
		<script src="js/uni.webview.1.5.5.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="lib/marked.min.js"></script>
		<script src="lib/prettify.min.js"></script>
		<script src="lib/raphael.min.js"></script>
		<script src="lib/underscore.min.js"></script>
		<script src="lib/sequence-diagram.min.js"></script>
		<script src="lib/flowchart.min.js"></script>
		<script src="lib/jquery.flowchart.min.js"></script>
		<script src="editormd.js"></script>
		<script type="text/javascript">
			var testEditor;
			function markdown(nr) {
				let content = ''
			
				
				if(typeof nr == 'string'){
					let cto = JSON.parse(nr);
					if(cto.render=='android'){
						content = decodeURIComponent(atob(cto.value))
					}else{
						content = decodeURIComponent(cto.value)
					}
					
					
				}else{
					if(nr.render=='android'){
						
						content = decodeURIComponent(atob(nr.value))
					}else{
						content = decodeURIComponent(nr.value)
					}
				}
				
				
				// $('#test-editormd-view').text(nr)

				testEditor = editormd("test-editormd", {
					markdown:content,
					width: "100%",
					height: "100vh",
					watch: false,
					autoHeight: false,
					path: "lib/",
					htmlDecode: "style,script,iframe",
					tex: true,
					emoji: true,
					taskList: true,
					flowChart: true,
					sequenceDiagram: true,
					saveHTMLToTextarea:true,
					onwatch:function(){
						document.querySelector(".CodeMirror").style.setProperty("width",'0px')
						document.querySelector(".CodeMirror-scroll").scrollTo({top:0})
						document.querySelector(".editormd-preview").style.setProperty("width",'100%')
						document.querySelector(".markdown-body").scrollTo({top:0})
					},
					onunwatch:function(){
						document.querySelector(".CodeMirror").style.setProperty("width",'100%')
						document.querySelector(".CodeMirror-scroll").scrollTo({top:0})
						document.querySelector(".editormd-preview").style.setProperty("width",'0px')
						document.querySelector(".markdown-body").scrollTo({top:0})
					},
					toolbarIcons: function() {
						// Or return editormd.toolbarModes[name]; // full, simple, mini
						// Using "||" set icons align right.
						return [
							"undo", "redo", "|",
							"bold", "del", "italic", "quote", "uppercase", "lowercase", "|",
							"h1", "h2", "h3", "h4", "h5", "h6", "|",
							"list-ul", "list-ol", "hr", "|",
							"code", "table", "datetime", "pagebreak",
							"|", "watch"
						]
					},
				});
			
			}
			function getMarkdown(){
				
				var html = ""
				if(testEditor) {
					html = testEditor.getMarkdown()
				}
				
				window.parent.postMessage({
					action: 'toValue',
					data: encodeURIComponent(html),
					iframeId: iframeId
				}, '*');
				uni.postMessage({
					data: {
						action: 'toValue',
						data: encodeURIComponent(html)
					}
				})
				
				
			}
			function getHtml(){
				var html = ""
				if(testEditor) {
					html = testEditor.getHTML()
				}
				
				window.parent.postMessage({
					action: 'toValue',
					data: encodeURIComponent(html),
					iframeId: iframeId
				}, '*');
				uni.postMessage({
					data: {
						action: 'toValue',
						data: encodeURIComponent(html)
					}
				})
			}
			
			var frameElement = window.frameElement;
			var iframeId = frameElement == null ? "" : frameElement.getAttribute('id');

			// 等待初始化完毕
			document.addEventListener('UniAppJSBridgeReady', () => {
				window.parent.postMessage({
					action: 'onJSBridgeReady',
					data: '',
					iframeId: iframeId
				}, '*');
				uni.postMessage({
					data: {
						action: 'onJSBridgeReady'
					}
				})

			})
		</script>
	</body>
</html>