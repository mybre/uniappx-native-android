<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="editormd.preview.css" />
		<!-- <link rel="shortcut icon" href="https://pandao.github.io/editor.md/favicon.ico" type="image/x-icon" /> -->
		<style>
			.editormd-html-preview {
				width: 100%;
				margin: 0 auto;
				overflow: hidden;
				padding: 0px !important;
			}
			
			html,body{
				margin: 0;
				padding: 0;
			}
			#test-editormd-view{
				background: transparent;
			}
		</style>
	</head>
	<body>
		<div id="layout">
			<div id="test-editormd-view"></div>
		</div>
		<script src="js/uni.webview.1.5.5.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="lib/marked.min.js"></script>
		<script src="lib/prettify.min.js"></script>
		<script src="lib/raphael.min.js"></script>
		<script src="lib/underscore.min.js"></script>
		<script src="lib/sequence-diagram.min.js"></script>
		<script src="lib/flowchart.min.js"></script>
		<script src="lib/jquery.flowchart.min.js"></script>

		<script src="editormd.js"></script>
		<script type="text/javascript">
		var testEditormdView;
		
		var ober = window.MutationObserver||window.WebkitMutationObserver
		function getBodyHeight(){
			let item = document.querySelector("#layout");
			let height = item.offsetHeight;
			
			window.parent.postMessage({ action: 'offsetHeight', data: height,iframeId:iframeId}, '*');
			uni.postMessage({
				data: {
					action: 'offsetHeight',
					data:height
				}
			})
		}
		var oberlisent = new ober(function(list){
			getBodyHeight()
		})
		oberlisent.observe(document.querySelector("#layout"),{attributes:true,subtree:true})
		
		function markdown(nr,isHtml){
			let content = ''
			
			if(typeof nr == 'string'){
				let cto = JSON.parse(nr);
				if(cto.render=='android'){
					content = decodeURIComponent(atob(cto.value))
				}else{
					content = decodeURIComponent(cto.value)
				}
				
			}else{
				if(nr.render=='android'){
					
					content = decodeURIComponent(atob(nr.value))
				}else{
					content = decodeURIComponent(nr.value)
				}
			}
			
			if(isHtml){
				document.querySelector("#layout").innerHTML = content
				getBodyHeight()
				return;
			}
			
			$('#test-editormd-view').text('')
			
			setTimeout(function() {
				testEditormdView = editormd.markdownToHTML("test-editormd-view", {
					markdown: "\n\n"+content, 
					htmlDecode      : true, 
					toc             : true,
					tocm: true, // Using [TOCM]
					emoji: true,
					taskList: true,
					tex: true, // 默认不解析
					flowChart: true, // 默认不解析
					sequenceDiagram: true, // 默认不解析
				});
				getBodyHeight()
			}, 0);
		}
		
		// 在iframe内部执行以下代码
		var frameElement = window.frameElement;
		var iframeId = frameElement==null?"":frameElement.getAttribute('id');
		
		
		// 等待初始化完毕
		document.addEventListener('UniAppJSBridgeReady', () => {
			window.parent.postMessage({ action: 'onJSBridgeReady', data: '',iframeId:iframeId}, '*');
			uni.postMessage({
				data: {
					action: 'onJSBridgeReady'
				}
			})
			
		})
		
		
		
		</script>
	</body>
</html>